import{_ as s,c as n,o as a,d as l}from"./app.7410356c.js";const p="/assets/closure_variable.2be94562.png",o="/assets/closure_function.14addbf1.png",e="/assets/closure_outer.e0dc139d.png",g=JSON.parse('{"title":"闭包","description":"","frontmatter":{},"headers":[{"level":2,"title":"词法环境","slug":"词法环境","link":"#词法环境","children":[]},{"level":2,"title":"闭包","slug":"闭包-1","link":"#闭包-1","children":[]},{"level":2,"title":"垃圾回收","slug":"垃圾回收","link":"#垃圾回收","children":[]}],"relativePath":"fe/basic/js/function/closure.md","lastUpdated":1682650439000}'),t={name:"fe/basic/js/function/closure.md"},c=l('<h1 id="闭包" tabindex="-1">闭包 <a class="header-anchor" href="#闭包" aria-hidden="true">#</a></h1><p>闭包 (closure) 是指函数声明时会绑定外部环境的变量，无论传递到哪里，后续调用仍能访问和修改声明时的外部变量 (而不是调用时的外部环境)。</p><p>通常用于函数一等公民的编程语言。</p><h2 id="词法环境" tabindex="-1">词法环境 <a class="header-anchor" href="#词法环境" aria-hidden="true">#</a></h2><p>变量有 3 种作用域，只在所处的作用域中可见：</p><ul><li>全局作用域</li><li>函数作用域</li><li>块作用域</li></ul><p>每个作用域有一个称为<strong>词法环境 (Lexical Environment)</strong> 的隐藏对象。</p><p>词法环境有 2 部分：</p><ul><li>环境记录 (Environment Record)：作用域内所有局部变量</li><li>对外部词法环境的引用 (全局词法环境无外部引用)</li></ul><p>对于<strong>变量</strong>来说，词法环境预先读取所有声明的变量，设为未初始化 (Uninitialized) 状态，在遇到声明之前不能引用，就像该变量不存在一样。遇到声明语句后，变量可以被读取和修改。</p><p><img src="'+p+'" alt=""></p><p>对于<strong>函数</strong>来说，词法环境会预先<strong>读取并初始化</strong>所有声明的函数，允许调用下方声明的函数。</p><p><img src="'+o+'" alt=""></p><p>访问变量时，首先搜索当前作用域的词法环境，其次是外部以及更外部，直到全局。如果都没找到，严格模式下报错，非严格模式下会声明一个全局变量。</p><h2 id="闭包-1" tabindex="-1">闭包 <a class="header-anchor" href="#闭包-1" aria-hidden="true">#</a></h2><p>函数作用域也有自己的词法环境，使用 <code>[[Environment]]</code> 隐藏属性存储对外部环境的引用，创建函数时会自动设置这个属性。</p><p>不管这个函数被传递到什么地方调用，调用时的外部词法环境永远是<strong>声明时</strong>的外部环境，与调用时的外部环境无关，保证了函数的可用性。</p><p><img src="'+e+`" alt=""></p><h2 id="垃圾回收" tabindex="-1">垃圾回收 <a class="header-anchor" href="#垃圾回收" aria-hidden="true">#</a></h2><p>函数执行结束后，如果没有其他环境引用这个函数环境，该环境会从内存中删除（垃圾回收）。</p><p>对于返回函数的函数，返回的函数引用了外部函数的词法环境，就不会发生垃圾回收，直到返回的函数不再使用，才会回收外部函数的环境。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">123</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> g </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 当 g 函数存在时，f 的环境会被保留在内存中</span></span>
<span class="line"><span style="color:#A6ACCD;">g </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 现在内存被清理了</span></span>
<span class="line"></span></code></pre></div><p>目前主流的 V8 引擎会对这种情况做一些优化，如果返回的函数<strong>没有引用外部环境的任何变量</strong>，则外部环境也没有必要保存，会从外部环境链上删除。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> value </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Surprise!</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">the closest value</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">g</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#F78C6C;">debugger</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 在 Console 中输入 value 会显示 &quot;Surprise!&quot;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">g</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> g </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">f</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">g</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div>`,24),r=[c];function i(y,F,D,A,C,d){return a(),n("div",null,r)}const h=s(t,[["render",i]]);export{g as __pageData,h as default};
